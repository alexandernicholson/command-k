name: Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install tmux
        run: sudo apt-get update && sudo apt-get install -y tmux

      - name: Install gum
        run: |
          curl -fsSL https://github.com/charmbracelet/gum/releases/download/v0.14.5/gum_0.14.5_Linux_x86_64.tar.gz -o /tmp/gum.tar.gz
          tar -xzf /tmp/gum.tar.gz -C /tmp
          sudo mv /tmp/gum_0.14.5_Linux_x86_64/gum /usr/local/bin/
          chmod +x /usr/local/bin/gum

      - name: Make scripts executable
        run: |
          chmod +x scripts/*.sh
          chmod +x cmdk
          chmod +x tests/test.sh

      - name: Start tmux server
        run: |
          tmux new-session -d -s test
          sleep 1

      - name: Source plugin
        run: |
          tmux source-file command-k.tmux || true

      - name: Run tests
        run: |
          # Run tests inside tmux so pane tests work
          tmux send-keys -t test './tests/test.sh' Enter
          sleep 3
          tmux capture-pane -t test -p

      - name: Check test results
        run: |
          # Run again to get exit code
          ./tests/test.sh
